var xReadingListApp=angular.module("xReadingList",["infinite-scroll"]);xReadingListApp.controller("QueryController",["$http","$location","$anchorScroll","NameList","Collection",function(e,s,t,r,i){"use strict";var l=this;l.issues=0,l.startYear=1963,l.endYear=2015,l.titles=new r.CreateList("Titles",!1),l.characters=new r.CreateList("Characters",!0),l.writers=new r.CreateList("Writers",!1),l.pencillers=new r.CreateList("Pencillers",!1),l.inkers=new r.CreateList("Inkers",!1),l.collection=new i.CreateCollection,l.showQuery=!0,l.lists=[l.titles,l.characters,l.writers,l.pencillers,l.inkers],l.hideResults=function(){l.showQuery=!0,s.hash("query"),t()},l.query=function(){e.post("/issues",{requiredCharacters:l.characters.allOf,optionalCharacters:l.characters.anyOf,excludedCharacters:l.characters.excluded,optionalTitles:l.titles.anyOf,excludedTitles:l.titles.excluded,optionalWriters:l.writers.anyOf,excludedWriters:l.writers.excluded,optionalPencillers:l.pencillers.anyOf,excludedPencillers:l.pencillers.excluded,optionalInkers:l.inkers.anyOf,excludedInkers:l.inkers.excluded,startYear:Math.min(l.startYear),endYear:Math.max(l.endYear)}).success(function(e){l.issues=e.length,l.showQuery=!1,l.collection.clear(),l.collection.addIssues(e),s.hash("results-list"),t()})}}]),$(function(){$(window).scroll(function(){var e=$(window).scrollTop();$(".fixed-title").each(function(){e>$(this).parent().offset().top?($(".fixed-title").removeClass("fixed"),$(this).addClass("fixed")):$(this).removeClass("fixed")})}),$(".selecting").click(function(){$(this).toggleClass("fixed-title"),$(this).removeClass("fixed")})});
function issueSort(e,s){return isNaN(e.number)?1:isNaN(s.number)?-1:Number(e.number)-Number(s.number)}angular.module("xReadingList").factory("Collection",["MarvelService",function(e){"use strict";function s(){var s=this;s.comics=[],s.debug="?",s.clear=function(){s.comics=[]},s.getSeries=function(e){var r,u=null;for(r=0;r<s.comics.length;r+=1)if(s.comics[r].name===e){u=s.comics[r];break}return u||(u={name:e,volumes:[],issues:[]},s.comics.push(u)),u},s.getIssues=function(e,s){var r,u,o=null;for(r=0;r<e.volumes.length;r+=1)if(e.volumes[r].name===s){o=e.volumes[r].issues;break}return o||(u={name:s,issues:[],selectedIssue:!1,expand:!1},e.volumes.push(u),o=u.issues),o},s.addIssues=function(r){var u,o,n,t,i,l,m=[];for(o=0;o<r.length;o+=1){for(i=r[o],t=s.getSeries(i.series,s.comics),n=s.getIssues(t,i.volume),i.number||(i.number="Oneshot"),u=0;u<n.length&&n[u].number!==i.number;u+=1);for(u===n.length?(i.coverRoot="http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available",i.extension="jpg",i.urls=[{type:"Marvel.com",url:"http://www.marvel.com"}],n.push(i),n.sort(issueSort)):(i.coverRoot=n[u].coverRoot,i.extension=n[u].extension,i.urls=n[u].urls,n[u]=i),l=0;l<m.length&&(m[l].series!==i.series||m[l].volume!==i.volume);l+=1);l===m.length&&m.push({series:i.series,volume:i.volume,list:n})}for(l=0;l<m.length;l+=1)e.getMarvelVolumeData(m[l].series,m[l].volume,0,m[l].list)}}return{CreateCollection:s}}]);
angular.module("xReadingList").controller("DetailsController",["$http","$location","$anchorScroll",function(t,s,l){"use strict";var e=this;e.issue={},e.showDetails=!1,e.lastId=null,e.urls=[],e.coverRoot="http://i.annihil.us/u/prod/marvel/i/mg/b/40/image_not_available",e.extension="jpg",e.getDetails=function(i,o){i._id!==e.lastId?(s.hash(o+"-details"),l(),e.showDetails=!0,e.lastId=i._id,e.coverRoot=i.coverRoot,e.extension=i.extension,e.urls=i.urls,t.get("/details/"+i._id).success(function(t){t.length>0&&(e.issue=t[0])})):(e.showDetails=!1,e.lastId=null)}}]);
function mapUrls(t){var e,a,r={reader:"Read on Marvel Unlimited",purchase:"Buy Digital Copy ",detail:"Details on Marvel"},s=[];for(a=0;a<t.length;a+=1)e=r[t[a].type]||"",e&&s.push({type:e,url:t[a].url});return s.length>0?s:[{type:"Marvel.com",url:"http://www.marvel.com"}]}angular.module("xReadingList").service("MarvelService",["$http",function(t){function e(t){var e=t;return function(t){t.data&&t.data.results&&t.data.results.length>0&&(e.coverRoot=t.data.results[0].thumbnail.path,e.extension=t.data.results[0].thumbnail.extension,e.urls=mapUrls(t.data.results[0].urls))}}function a(a){var r="http://gateway.marvel.com:80/v1/public/comics?title="+a.series+"&startYear="+a.volume+"&issueNumber="+a.number+"&noVariants=true&apikey=2c7b5e832ec9ddc7c4dc4e432f24fbb4";t.get(r,{cache:!0}).success(e(a))}function r(t,e,a,r){var u=t,l=e,n=a,i=r+100,c={};for(j=0;j<n.length;j+=1)c[n[j].number]=n[j];return function(t){var e,a,r,o;if(t.data&&t.data.results)for(e=0;e<t.data.results.length;e+=1)a=t.data.results[e],o=c[a.issueNumber.toString()],o&&(o.coverRoot=a.thumbnail.path,o.extension=a.thumbnail.extension,o.urls=mapUrls(a.urls));r=t.data.offset+t.data.count,r<t.data.total&&t.data.limit===t.data.count&&1e3>i&&s(u,l,i,n)}}function s(e,a,s,u){var l="http://gateway.marvel.com:80/v1/public/comics?title="+e+"&startYear="+a+"&formatType=comic&offset="+s+"&limit=100&noVariants=true&orderBy=issueNumber&apikey=2c7b5e832ec9ddc7c4dc4e432f24fbb4";t.get(l,{cache:!0}).success(r(e,a,u,s))}return{getMarvelData:a,getMarvelVolumeData:s}}]);
function addNameToList(e,t){t.push(e),t.sort()}function removeNameFromList(e,t){var i=t.indexOf(e);i>=0&&t.splice(i,1)}angular.module("xReadingList").factory("NameList",["$http","$filter",function(e,t){"use strict";function i(i,l){var s=this;s.title=i,s.names=[],s.allOf=[],s.anyOf=[],s.excluded=[],s.selecting=!1,s.hasAllColumn=l,s.limit=25,s.displayList=[],s.searchText="",e.get("/list/"+i,{cache:!0}).success(function(e){e&&e.length>0&&(s.names=e[0].names,s.names.sort())}),this.updateDisplayList=function(){s.displayList=s.searchText?t("filter")(s.names,s.searchText):s.names,s.displayList=t("limitTo")(s.displayList,s.limit)},this.setSelecting=function(){s.selecting=!s.selecting,s.limit=50,s.updateDisplayList()},this.increaseLimit=function(){s.limit+=25,s.updateDisplayList()},this.clearSelections=function(){s.allOf=[],s.anyOf=[],s.excluded=[]},this.getDescription=function(){var e=[];return s.allOf.length>0&&e.push("All of: "+s.allOf.join(", ")),s.anyOf.length>0&&e.push("Any of: "+s.anyOf.join(", ")),s.excluded.length>0&&e.push("Excluding: "+s.excluded.join(", ")),e},this.toggleList=function(e,t){var i,l,n;if("All"===e?(l=s.allOf,n=[s.anyOf,s.excluded]):"Any"===e?(l=s.anyOf,n=[s.allOf,s.excluded]):"Exclude"===e&&(l=s.excluded,n=[s.allOf,s.anyOf]),l.indexOf(t)>=0)removeNameFromList(t,l);else for(addNameToList(t,l),i=0;i<n.length;i+=1)removeNameFromList(t,n[i])}}return{CreateList:i}}]);
function addToSequence(e,n,u){return e.length>0&&(e+=", "),n===u?e+=u:e=e+n+"-"+u,e}angular.module("xReadingList").filter("sequence",function(){"use strict";return function(e){var n,u,r,t="";if(1===e.length)t=e[0].number;else if(e.length>1)for(u=r=e[0].number,n=1;n<e.length;n+=1)Number(e[n].number)===Number(r)+1?r=e[n].number:(t=addToSequence(t,u,r),u=r=e[n].number),n===e.length-1&&(t=addToSequence(t,u,r));return t}});